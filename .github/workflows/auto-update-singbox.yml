name: Auto Update sing-box Core (Multi-Platform)

on:
  workflow_dispatch:
  schedule:
    - cron: "35 */6 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip

      - name: Fetch latest release + compare
        id: rel
        run: |
          set -euo pipefail
          json="$(curl -fsSL https://api.github.com/repos/SagerNet/sing-box/releases/latest)"
          tag="$(echo "$json" | jq -r '.tag_name')"
          echo "$json" > release.json
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

          current="none"
          [[ -f VERSION ]] && current="$(tr -d ' \n\r' < VERSION)"
          echo "current=$current"
          echo "latest=$tag"
          [[ "$current" == "$tag" ]] && echo "need=false" >> "$GITHUB_OUTPUT" || echo "need=true" >> "$GITHUB_OUTPUT"

      - name: Update all targets
        if: steps.rel.outputs.need == 'true'
        run: |
          set -euo pipefail

          # sing-box 常见：类 Unix 用 tar.gz，Windows 多是 zip（也可能有 tar.gz）
          # 我们按“先匹配 tar.gz，不行再匹配 zip”的策略写，容错更高。

          declare -A REGEX_TGZ REGEX_ZIP BIN OUT
          BIN[linux-amd64]='sing-box'
          OUT[linux-amd64]='cores/linux-amd64/sing-box'
          REGEX_TGZ[linux-amd64]='linux.*amd64.*\.tar\.gz$'
          REGEX_ZIP[linux-amd64]='linux.*amd64.*\.zip$'

          BIN[linux-arm64]='sing-box'
          OUT[linux-arm64]='cores/linux-arm64/sing-box'
          REGEX_TGZ[linux-arm64]='linux.*(arm64|aarch64).*\.tar\.gz$'
          REGEX_ZIP[linux-arm64]='linux.*(arm64|aarch64).*\.zip$'

          BIN[darwin-amd64]='sing-box'
          OUT[darwin-amd64]='cores/darwin-amd64/sing-box'
          REGEX_TGZ[darwin-amd64]='darwin.*amd64.*\.tar\.gz$'
          REGEX_ZIP[darwin-amd64]='darwin.*amd64.*\.zip$'

          BIN[darwin-arm64]='sing-box'
          OUT[darwin-arm64]='cores/darwin-arm64/sing-box'
          REGEX_TGZ[darwin-arm64]='darwin.*(arm64|aarch64).*\.tar\.gz$'
          REGEX_ZIP[darwin-arm64]='darwin.*(arm64|aarch64).*\.zip$'

          BIN[windows-amd64]='sing-box.exe'
          OUT[windows-amd64]='cores/windows-amd64/sing-box.exe'
          REGEX_TGZ[windows-amd64]='windows.*amd64.*\.tar\.gz$'
          REGEX_ZIP[windows-amd64]='windows.*amd64.*\.zip$'

          BIN[windows-arm64]='sing-box.exe'
          OUT[windows-arm64]='cores/windows-arm64/sing-box.exe'
          REGEX_TGZ[windows-arm64]='windows.*(arm64|aarch64).*\.tar\.gz$'
          REGEX_ZIP[windows-arm64]='windows.*(arm64|aarch64).*\.zip$'

          rm -rf tmp && mkdir -p tmp

          pick_url() {
            local tgz_re="$1"
            local zip_re="$2"
            local u=""
            u="$(jq -r --arg re "$tgz_re" '.assets[] | select(.name|test($re)) | .browser_download_url' release.json | head -n 1)"
            if [[ -z "${u:-}" || "$u" == "null" ]]; then
              u="$(jq -r --arg re "$zip_re" '.assets[] | select(.name|test($re)) | .browser_download_url' release.json | head -n 1)"
            fi
            echo "$u"
          }

          for id in linux-amd64 linux-arm64 darwin-amd64 darwin-arm64 windows-amd64 windows-arm64; do
            echo "==> Updating $id"
            rm -rf tmp/* && mkdir -p tmp

            url="$(pick_url "${REGEX_TGZ[$id]}" "${REGEX_ZIP[$id]}")"
            if [[ -z "${url:-}" || "$url" == "null" ]]; then
              echo "❌ 未匹配到 $id 资产："
              echo "  tgz: ${REGEX_TGZ[$id]}"
              echo "  zip: ${REGEX_ZIP[$id]}"
              echo "可用资产："
              jq -r '.assets[].name' release.json
              exit 1
            fi

            if [[ "$url" =~ \.zip$ ]]; then
              curl -fL "$url" -o tmp/core.zip
              unzip -o tmp/core.zip -d tmp/unz
              bin="$(find tmp/unz -type f -name "${BIN[$id]}" | head -n 1)"
            else
              curl -fL "$url" -o tmp/core.tgz
              tar -xzf tmp/core.tgz -C tmp
              bin="$(find tmp -type f -name "${BIN[$id]}" | head -n 1)"
            fi

            [[ -z "${bin:-}" ]] && (echo "❌ 包内找不到：${BIN[$id]}"; find tmp -maxdepth 4 -type f; exit 1)

            out="${OUT[$id]}"
            mkdir -p "$(dirname "$out")"
            install -m 0755 "$bin" "$out"
          done

          echo "${{ steps.rel.outputs.tag }}" > VERSION

      - name: Commit & push
        if: steps.rel.outputs.need == 'true'
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cores VERSION
          git commit -m "chore: update sing-box core to ${{ steps.rel.outputs.tag }}" || exit 0
          git push
