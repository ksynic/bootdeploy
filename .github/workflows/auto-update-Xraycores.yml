set -euo pipefail

declare -A REGEX BIN OUT

REGEX[linux-amd64]='^Xray-linux-64\.zip$'
BIN[linux-amd64]='xray'
OUT[linux-amd64]='cores/linux-amd64/xray'

REGEX[linux-arm64]='^Xray-linux-arm64-v8a\.zip$'
BIN[linux-arm64]='xray'
OUT[linux-arm64]='cores/linux-arm64/xray'

REGEX[macos-amd64]='^Xray-macos-64\.zip$'
BIN[macos-amd64]='xray'
OUT[macos-amd64]='cores/darwin-amd64/xray'   # 你想改名就改成 cores/macos-amd64/xray

REGEX[macos-arm64]='^Xray-macos-arm64-v8a\.zip$'
BIN[macos-arm64]='xray'
OUT[macos-arm64]='cores/darwin-arm64/xray'   # 同上

REGEX[windows-amd64]='^Xray-windows-64\.zip$'
BIN[windows-amd64]='xray.exe'
OUT[windows-amd64]='cores/windows-amd64/xray.exe'

REGEX[windows-arm64]='^Xray-windows-arm64-v8a\.zip$'
BIN[windows-arm64]='xray.exe'
OUT[windows-arm64]='cores/windows-arm64/xray.exe'

mkdir -p tmp

for id in linux-amd64 linux-arm64 macos-amd64 macos-arm64 windows-amd64 windows-arm64; do
  echo "==> Updating $id"
  rm -rf tmp/*

  regex="${REGEX[$id]}"
  url="$(jq -r --arg re "$regex" '.assets[] | select(.name|test($re)) | .browser_download_url' release.json | head -n 1)"

  if [[ -z "${url:-}" || "$url" == "null" ]]; then
    echo "⚠️ Skip $id: 未匹配到资产：$regex"
    continue
  fi

  curl -fL "$url" -o tmp/core.zip
  unzip -o tmp/core.zip -d tmp/unz

  bin_name="${BIN[$id]}"
  bin="$(find tmp/unz -type f -name "$bin_name" | head -n 1)"
  if [[ -z "${bin:-}" ]]; then
    echo "⚠️ Skip $id: zip 内找不到 $bin_name"
    continue
  fi

  out="${OUT[$id]}"
  mkdir -p "$(dirname "$out")"
  install -m 0755 "$bin" "$out"
done
