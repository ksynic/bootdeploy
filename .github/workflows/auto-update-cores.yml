name: Auto Update Xray & sing-box cores

on:
  workflow_dispatch:
  schedule:
    - cron: "20 */6 * * *" # 每 6 小时跑一次（UTC）

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: xray
            owner: XTLS
            repo: Xray-core
            version_path: cores/xray/VERSION
            out_path: cores/xray/xray-linux-amd64
            # Xray Release 资产里通常带 linux-64 zip
            asset_regex: 'Xray-linux-64\.zip$'
            bin_inside_zip: 'xray'

          - name: sing-box
            owner: SagerNet
            repo: sing-box
            version_path: cores/sing-box/VERSION
            out_path: cores/sing-box/sing-box-linux-amd64
            # sing-box Release 资产命名会随版本变化，下面用 linux-amd64 tar.gz 做例子
            asset_regex: 'linux-amd64.*\.tar\.gz$'
            bin_inside_tgz: 'sing-box'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip

      - name: Fetch latest release info
        id: rel
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${{ matrix.owner }}/${{ matrix.repo }}/releases/latest"
          json="$(curl -fsSL "$api")"
          tag="$(echo "$json" | jq -r '.tag_name')"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "$json" > release.json

      - name: Compare version
        id: cmp
        run: |
          set -euo pipefail
          latest="${{ steps.rel.outputs.tag }}"
          current="none"
          if [[ -f "${{ matrix.version_path }}" ]]; then
            current="$(cat "${{ matrix.version_path }}" | tr -d ' \n\r')"
          fi
          echo "current=$current"
          echo "latest=$latest"
          if [[ "$current" == "$latest" ]]; then
            echo "need_update=false" >> "$GITHUB_OUTPUT"
          else
            echo "need_update=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Download & extract (Xray zip)
        if: steps.cmp.outputs.need_update == 'true' && matrix.name == 'xray'
        run: |
          set -euo pipefail
          url="$(jq -r --arg re "${{ matrix.asset_regex }}" '.assets[] | select(.name|test($re)) | .browser_download_url' release.json | head -n 1)"
          if [[ -z "${url:-}" || "$url" == "null" ]]; then
            echo "No asset matched regex: ${{ matrix.asset_regex }}"
            echo "Available assets:"
            jq -r '.assets[].name' release.json
            exit 1
          fi

          mkdir -p "$(dirname "${{ matrix.out_path }}")"
          rm -rf tmp && mkdir -p tmp
          curl -fL "$url" -o tmp/core.zip
          unzip -o tmp/core.zip -d tmp/unz
          chmod +x "tmp/unz/${{ matrix.bin_inside_zip }}"
          install -m 0755 "tmp/unz/${{ matrix.bin_inside_zip }}" "${{ matrix.out_path }}"

      - name: Download & extract (sing-box tar.gz)
        if: steps.cmp.outputs.need_update == 'true' && matrix.name == 'sing-box'
        run: |
          set -euo pipefail
          url="$(jq -r --arg re "${{ matrix.asset_regex }}" '.assets[] | select(.name|test($re)) | .browser_download_url' release.json | head -n 1)"
          if [[ -z "${url:-}" || "$url" == "null" ]]; then
            echo "No asset matched regex: ${{ matrix.asset_regex }}"
            echo "Available assets:"
            jq -r '.assets[].name' release.json
            exit 1
          fi

          mkdir -p "$(dirname "${{ matrix.out_path }}")"
          rm -rf tmp && mkdir -p tmp
          curl -fL "$url" -o tmp/core.tgz
          tar -xzf tmp/core.tgz -C tmp

          # 在解压目录里找 sing-box 可执行文件（不同打包层级可能不一样）
          bin="$(find tmp -type f -name "${{ matrix.bin_inside_tgz }}" | head -n 1)"
          if [[ -z "${bin:-}" ]]; then
            echo "Cannot find binary: ${{ matrix.bin_inside_tgz }}"
            find tmp -maxdepth 3 -type f
            exit 1
          fi

          chmod +x "$bin"
          install -m 0755 "$bin" "${{ matrix.out_path }}"

      - name: Update VERSION
        if: steps.cmp.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "${{ matrix.version_path }}")"
          echo "${{ steps.rel.outputs.tag }}" > "${{ matrix.version_path }}"

      - name: Commit & push
        if: steps.cmp.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ matrix.out_path }}" "${{ matrix.version_path }}"
          git commit -m "chore(${{
            matrix.name
          }}): update core to ${{ steps.rel.outputs.tag }}" || exit 0
          git push
